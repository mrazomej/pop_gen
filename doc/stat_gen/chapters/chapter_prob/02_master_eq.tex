\section{The (continuous) master equation for allele frequencies}

One of the most powerful tools to study stochastic process is the so-called
master equation. Originally devised to study the stochastic time evolution of
chemical reactions - thereby christened the chemical master equation - this
equation has found applications in many areas of chemistry, physics and biology.
The equation is as statement about the time evolution of the transition
probabilities of a Markov process. That is just a fancy way of saying that the
master equation describes how the transition probabilities between states change
over time.

Let's derive this powerful equation starting from \eref{eq_chapman_kolmogorov}.
For our case of study where we want to understand how the frequency of a
particular allele evolves over time, that is a stochastic process $F(t)$. Notice
again that we distinguish between the stochastic process $F(t)$ formed by the
ensemble of all possible realizations $f(t)$. The Chapman-Kolmogorov equation
for this particular case with three time points $t_1 < t_2 < t_3$ takes the form
\begin{equation}
  P(f_3, t_3 \mid f_1, t_1) = \int_0^1 df_2\; P(f_3, t_3 \mid f_2, t_2)
                                          P(f_2, t_2 \mid f_1, t_1),
  \label{eq_chapman_freq}
\end{equation}
where the integration limits $[0, 1]$ are the domain of values that an allele
frequency can take. Now let us assume that we observe the frequency at time $t$
and it happens to be at a value $f_1$. Then after a very short time $\Dt$ we
observe again the allele frequency which is now at a value $f_2$. Under this
short time limit we can approximate the transition probability as
\begin{equation}
  P(f_2, t + \Dt \mid f_1, t) = \delta(f_2 - f_1)
  \underbrace{\left[ 1 - a^{(0)}(f_1, t) \Dt \right]}_{\text{probability
  of no transition}} +
  \underbrace{\phi_t(f_2 \mid f_1)\Dt}_\text{probability of transition} +
  \mathcal{O}(\Dt^2).
  \label{eq_transition_short_time}
\end{equation}
Let's break down this equation. We have split the possible things that can
happen on a time window $\Dt$ into two possible cases. The first one
represented by the first term is the possibility that on this small time window
no transition actually takes place. The $\delta$-function that is equal to 1 if
and only if $f_2 = f_1$ is there to make sure that this term is added only when
there was no transition during that time and $f_2$ remains the same as $f_1$.
Inside the square brackets we wrote $1 - a^{(0)}(f_1, t) \Dt$, the reason
for writing the term $a^{(0)}$ will become clear later on when we derive the
Fokker-Planck equation. Having a term of the form 1 - ``something'' hints at the
fact that this ``something'' must be the probability of transitioning somewhere
else rather than staying at the same position. For the second term we wrote
$\phi_t(f_2 \mid f_1)\Dt$ as the probability of transitioning outside of $f_1$
during this time window. our function $\phi_t(f_2 \mid f_1)$ represents the
transition rate between $f_1$ and $f_2$ at time $t$. When we multiply this rate
in time$^{-1}$ units times a small time window, we obtain the probability of
transitioning from $f_1$ to $f_2$.

In order to understand better the term $a^{(0)}(f_1, t)$ in
\eref{eq_transition_short_time} recall that a probability distribution must be
normalized. That means that if we integrate both sides of
\eref{eq_transition_short_time} over all values of $f_2$ it must be true that
\begin{equation}
  1 = \int_0^1 df_2 \; P(f_2, t + \Dt \mid f_1, t) =
  \int_0^1 df_2 \; \delta(f_2 - f_1) \left[ 1 - a^{(0)}(f_1, t) \Dt \right]
  + \int_0^1 df_2 \; \phi_t(f_2 \mid f_1)\Dt.
\end{equation}
Integrating over the $\delta$-function implies that we set $f_2 = f_1$,
therefore we obtain
\begin{equation}
  1 = \left[  1 - a^{(0)}(f_1, t) \Dt\right] +
  \int_0^1 df_2 \; \phi_t(f_2 \mid f_1)\Dt.
\end{equation}
Simplifying terms gives
\begin{equation}
  a^{(0)}(f_1, t) = \int_0^1 df_2 \; \phi_t(f_2 \mid f_1),
  \label{eq_a0}
\end{equation}
demonstrating our previous assertion that $a^{(0)}(f_1, t)$ must be the
probability of jumping from $f_1$ to somewhere else.

Using this approximation for short time steps we will now derive the
differential equation that the transition probability between frequencies must
obey. Specifically for three time points $t_o < t < t + \Dt$ with corresponding
allele frequencies $f_o, f', f$ we have that \eref{eq_chapman_freq} takes the
form
\begin{equation}
  P(f, t + \Dt \mid f_o, t_o) = \int_0^1 df' \; P(f, t + \Dt \mid f', t)
  P(f', t \mid f_o, t_o).
\end{equation}
Substituting \eref{eq_transition_short_time} results in
\begin{equation}
  P(f, t + \Dt \mid f_o, t_o) = \int_0^1 df' \;
  \left[ \delta(f - f') \left( 1 - a^{(0)}(f', t)\Dt \right)
  + \phi_t(f \mid f')\Dt \right]
  P(f', t \mid f_o, t_o).
\end{equation}
Evaluating the integral for the first term on the right-hand side results in
\begin{equation}
  P(f, t + \Dt \mid f_o, t_o) = \left[\left( 1 - a^{(0)}(f, t)\Dt \right)\right]
  P(f, t \mid f_o, t_o) +
  \Dt \int_0^1 df' \; \phi_t(f \mid f') P(f', t \mid f_o, t_o).
\end{equation}
We can then substitute \eref{eq_a0} and rearrange terms to obtain
\begin{equation}
  P(f, t + \Dt \mid f_o, t_o) = P(f, t \mid f_o, t_o)
  + \int_0^1 df' \left[ \phi_t(f \mid f') P(f', t \mid f_o, t_o) -
  \phi_t(f' \mid f) P(f, t \mid f_o, t_o) \right]\Dt.
\end{equation}
Sending the first term on the right-hand side to the left, dividing both sides
by $\Dt$ and taking the limit $\Dt \rightarrow 0$ gives the differential
equation we were looking for
\begin{equation}
  \ddt{P(f, t \mid f_o, t_o)} = \int_0^1 df' \;
  \underbrace{
  \left[ \phi_t(f \mid f') P(f', t \mid f_o, t_o) \right.}
  _{\text{gain } f' \rightarrow f}  -
  \underbrace{
  \left. \phi_t(f' \mid f) P(f, t \mid f_o, t_o) \right]}
  _{\text{loss } f \rightarrow f'}.
  \label{eq_master_eq_trans}
\end{equation}
This is the integro-differential equation known as the master equation. This
continuous form of the master equation describes the time evolution of the
transition probabilities $P(f, t \mid f_o, t_o)$, not the evolution of the
probability of being at a specific state $P(f, t)$. However we can use the rules
of probability to obtain such description by the following process: Suppose the
stochastic process $F(t)$ describes the time evolution of the frequency.
Assuming $F(t)$ is a stationary Markov process as described in
\secref{sec_stationary_process} means that this process is characterized by the
probability of having a particular value for the allele frequency $P_F(f)$ that
does not depend on time, and a transition probability $P(f, t \mid f_o, t_o)$.
We define a new, non-stationary process $F^*(t)$ for $t \geq t_o$ by setting
\begin{equation}
  P^*(f, t) = P(f, t\mid f_o, t_o),
\end{equation}
i.e. forcing the initial condition to be a specific value $f_o$ at time $t_o$.
This is a sub-ensemble of the process $F(t)$ since we demanded that $F(t = t_o)
= f_o$. More generally if instead of setting the initial condition to be a
single specific value $P(f, t_o) = \delta(f - f_o)$ we give a probability
distribution for the initial state $P(f, t_o) = \rho(f_o)$, we have a
sub-ensemble of the form
\begin{equation}
  P^*(f, t) = \int_0^1 df_o \; P(f, t\mid f_o, t_o) \rho(f_o).
  \label{eq_subensemble}
\end{equation}
The interpretation of this sub ensemble is that the system was initially set on
a non-stationary state. The initial state distribution $\rho(f_o)$ does not
depend on time. Therefore if we take the time derivative on both sides of
\eref{eq_subensemble} we find that
\begin{equation}
  \ddt{P^*(f, t)} = \int_0^1 df_o \; \ddt{P(f, t\mid f_o, t_o)}
                        \rho(f_o).
\label{eq_subensemble_dt}
\end{equation}
We notice that the term with the time derivative on the right-hand side of
\eref{eq_subensemble_dt} is the master equation that we derived in
\eref{eq_master_eq_trans}. Substituting this results in
\begin{equation}
  \ddt{P^*(f, t)} = \int_0^1 df_o \; \rho(f_o)
  \int_0^1 df' \;
  \left[ \phi_t(f \mid f') P(f', t \mid f_o, t_o) -
  \phi_t(f' \mid f) P(f, t \mid f_o, t_o) \right].
\end{equation}
Redistributing the integrals gives
\begin{equation}
  \ddt{P^*(f, t)} = \int_0^1 df' \; \phi_t(f \mid f')
  \overbrace{
  \int_0^1 df_o \; P(f', t \mid f_o, t_o) \rho(f_o)}
  ^{P^*(f', t)\text{ by definition}} -
  \int_0^1 df' \; \phi_t(f' \mid f)
  \overbrace{
  \int_0^1 df_o \; P(f, t \mid f_o, t_o) \rho(f_o)}
  ^{P^*(f, t)\text{ by definition}}.
\end{equation}
Using the definition of the sub-ensembles shown in \eref{eq_subensemble} we
arrive to a result of the form
\begin{equation}
  \ddt{P^*(f, t)} = \int_0^1 df' \;
  \left[
  \underbrace{
  \phi_t(f \mid f') P^*(f', t)
  }_{f' \rightarrow f \text{ gain}} -
  \underbrace{
  \phi_t(f' \mid f) P^*(f, t)
  }_{f \rightarrow f' \text{ loss}}
  \right].
\end{equation}
In this form we can see that the master equation is a balance between gain and
loss of probability at each state $f$. Having said that the truth about the
continuous master equation is that is extremely complicated to work with. In
general integro-differential equations are challenging mathematical objects to
deal with. That is why in the next section we'll use the powerful tool of
Taylor expansions to simplify the equation.
